webpackJsonp([2],{"7paM":function(e,t,a){"use strict";var n=a("9GPK"),i=a("y0/c"),s=a("t5DY"),o=a("++XJ"),r={name:"message-list",props:{roomData:{type:Object}},data:function(){return{MessageTypes:o.b,loading:!1,loadingController:!1,finished:!1,refreshing:!1,loadLastId:0,pagination:{current:1,pageSize:60,total:0}}},computed:{meAvatar:function(){return Object(n.e)().avatar||"https://wwcdn.weixin.qq.com/node/wework/images/kf_head_image_url_4.png"},messages:function(){var e=this.$store.state,t=this.roomData.room||0,a=e.msg.MessageMapList[t];return a||[]},getAvatar:function(){var e=this;return function(t){var a=e.$store.state.friend.FriendMap[t.sender];return a?a.avatar||"https://wwcdn.weixin.qq.com/node/wework/images/kf_head_image_url_4.png":(Object(i.a)({user_id:t.sender}),"https://wwcdn.weixin.qq.com/node/wework/images/kf_head_image_url_4.png")}}},mounted:function(){},methods:{init:function(){this.finished=!1;var e=this.$store.state,t=this.roomData.room||0,a=e.msg.MessageMapList[t];(!a||a.length<1)&&t>0?this.loadHistory():this.finished=!0},currentUuid:function(){return Object(n.b)()},loadHistory:function(){var e=this;this.roomData.room||(this.finished=!0),Object(s.e)({room_uuid:this.roomData.room,size:this.pagination.pageSize,last_id:this.loadLastId}).then(function(t){var a=t.data.length;if(a<1)return e.finished=!0,void(e.loading=!1);var n=document.getElementById("messageList"),i=n.scrollHeight;e.loadLastId=t.data[a-1].id||0,e.$store.dispatch("history",{recipient:e.roomData.room,messages:t.data.reverse()}),e.$nextTick(function(){1===e.pagination.current?e.scrollToBottom():n.scrollTop=n.scrollHeight-i,e.pagination.current++,setTimeout(function(){e.loading=!1},3e3)})}).catch(function(){e.loading=!1})},scrollToBottom:function(){this.$nextTick(function(){var e=document.getElementById("messageList");e.scrollTop=e.scrollHeight})}}},c={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"message-list",attrs:{id:"messageList"}},[a("van-list",{attrs:{id:"messageListScroll",finished:e.finished,"finished-text":"没有更多了",offset:80,direction:"up"},on:{load:e.loadHistory},model:{value:e.loading,callback:function(t){e.loading=t},expression:"loading"}},[e._l(e.messages,function(t,n){return[t.second_type!==e.MessageTypes.videoCall?a("div",{key:n,class:["message-box",{right:t.sender===e.currentUuid()}]},[t.sender!==e.currentUuid()?a("div",{staticClass:"avatar"},[a("img",{attrs:{src:e.getAvatar(t)}})]):e._e(),e._v(" "),t.sender===e.currentUuid()?a("div",{staticClass:"before-tip"},[e._e(),e._v(" "),e._e()],1):e._e(),e._v(" "),t.second_type===e.MessageTypes.text?[a("div",{staticClass:"text",domProps:{innerHTML:e._s(t.content)}})]:t.second_type===e.MessageTypes.image?[a("div",{staticClass:"image"},[a("img",{attrs:{src:t.content}})])]:e._e(),e._v(" "),t.sender===e.currentUuid()?a("div",{staticClass:"avatar"},[a("img",{attrs:{src:e.meAvatar}})]):e._e()],2):e._e()]})],2)],1)},staticRenderFns:[]};var d=a("VU/8")(r,c,!1,function(e){a("pNz+")},"data-v-e248d2c8",null).exports,l={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",[t("svg",{staticClass:"icon",attrs:{t:"1647771122497",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"16033",width:"32",height:"32"}},[t("path",{attrs:{d:"M410.208 319.776a96 96 0 0 1 192 0v192.448a96 96 0 0 1-96 95.744 96 96 0 0 1-96-95.744V319.776z m96 352.192c88.192 0 160-71.648 160-159.744V319.776a160.096 160.096 0 0 0-160-159.776c-88.224 0-160 71.68-160 159.776v192.448a160.032 160.032 0 0 0 160 159.744zM742.4 448a32 32 0 0 0-32 32v24.672c0 116.192-94.72 210.688-211.2 210.688-116.448 0-211.2-94.496-211.2-210.688V480a32 32 0 0 0-64 0v24.672c0 140.16 105.76 255.904 241.76 272.448V864a32 32 0 0 0 64 0v-86.432C667.168 762.304 774.4 645.824 774.4 504.672V480a32 32 0 0 0-32-32","p-id":"16034"}})])])},staticRenderFns:[]};var h=a("VU/8")({name:"voice"},l,!1,function(e){a("XPRr")},"data-v-29829874",null).exports,u={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",[t("svg",{staticClass:"icon",attrs:{t:"1647770199888",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"4299",width:"32",height:"32"}},[t("path",{attrs:{d:"M510.944 960c-247.04 0-448-200.96-448-448s200.992-448 448-448 448 200.96 448 448-200.96 448-448 448z m0-832c-211.744 0-384 172.256-384 384s172.256 384 384 384 384-172.256 384-384-172.256-384-384-384z",fill:"","p-id":"4300"}}),t("path",{attrs:{d:"M512 773.344c-89.184 0-171.904-40.32-226.912-110.624-10.88-13.92-8.448-34.016 5.472-44.896 13.888-10.912 34.016-8.48 44.928 5.472 42.784 54.688 107.136 86.048 176.512 86.048 70.112 0 134.88-31.904 177.664-87.552 10.784-14.016 30.848-16.672 44.864-5.888 14.016 10.784 16.672 30.88 5.888 44.864C685.408 732.32 602.144 773.344 512 773.344zM368 515.2c-26.528 0-48-21.472-48-48v-64c0-26.528 21.472-48 48-48s48 21.472 48 48v64c0 26.496-21.504 48-48 48zM656 515.2c-26.496 0-48-21.472-48-48v-64c0-26.528 21.504-48 48-48s48 21.472 48 48v64c0 26.496-21.504 48-48 48z",fill:"","p-id":"4301"}})])])},staticRenderFns:[]};var f=a("VU/8")({name:"emoji"},u,!1,function(e){a("CczY")},"data-v-7ff93387",null).exports,v={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",[t("svg",{staticClass:"icon",attrs:{t:"1647770134907",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"2981",width:"32",height:"32"}},[t("path",{attrs:{d:"M512 958.016c-119.648 0-232.128-46.368-316.736-130.56C110.624 743.2 64 631.2 64 512c0-119.168 46.624-231.2 131.232-315.424 84.608-84.192 197.088-130.56 316.736-130.56s232.128 46.368 316.704 130.56c84.672 84.224 131.264 196.256 131.264 315.392 0.032 119.2-46.592 231.232-131.264 315.456C744.128 911.616 631.648 958.016 512 958.016zM512 129.984c-102.624 0-199.072 39.744-271.584 111.936C167.936 314.048 128 409.984 128 512c0 102.016 39.904 197.952 112.384 270.048 72.512 72.192 168.96 111.936 271.584 111.936 102.592 0 199.072-39.744 271.584-111.936 72.48-72.16 112.416-168.064 112.384-270.08 0-102.016-39.904-197.92-112.384-270.016C711.072 169.76 614.592 129.984 512 129.984z","p-id":"2982"}}),t("path",{attrs:{d:"M736 480l-192 0L544 288c0-17.664-14.336-32-32-32s-32 14.336-32 32l0 192L288 480c-17.664 0-32 14.336-32 32s14.336 32 32 32l192 0 0 192c0 17.696 14.336 32 32 32s32-14.304 32-32l0-192 192 0c17.696 0 32-14.336 32-32S753.696 480 736 480z","p-id":"2983"}})])])},staticRenderFns:[]};var m=a("VU/8")({name:"add"},v,!1,function(e){a("Afxe")},"data-v-ff2a4b78",null).exports,g={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",[t("svg",{staticClass:"icon",attrs:{t:"1663664322351",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"2111",width:"32",height:"32"}},[t("path",{attrs:{d:"M658.069333 256a64 64 0 0 1 64 64l-0.021333 33.664 49.28-38.4A64 64 0 0 1 874.666667 365.781333v338.368a64 64 0 0 1-103.338667 50.474667l-49.28-38.4v26.496a64 64 0 0 1-64 64H213.333333a64 64 0 0 1-64-64V320a64 64 0 0 1 64-64h444.736z","p-id":"2112"}}),t("path",{attrs:{d:"M376.106667 638.933333l132.224-88.981333a21.333333 21.333333 0 0 0-0.170667-35.498667l-132.202667-87.274666a21.333333 21.333333 0 0 0-33.088 17.792v176.277333a21.333333 21.333333 0 0 0 33.237334 17.706667z","p-id":"2113"}})])])},staticRenderFns:[]};var p=a("VU/8")({name:"send-video"},g,!1,function(e){a("CTDB")},"data-v-6ae3d9c0",null).exports,C=a("mvHQ"),M=a.n(C),w={offerToReceiveVideo:!0,offerToReceiveAudio:!0},_=function(){var e,t,a,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{key:"tsm:"+Math.random().toString().substr(2,16),isSelf:!1,handleRemoteStream:null,handleIcecandidate:null},i={RTC:(e=function(e){"function"==typeof n.handleRemoteStream&&n.handleRemoteStream(e,i)},t=function(e){"function"==typeof n.handleIcecandidate&&n.handleIcecandidate(e,i)},a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),a.addEventListener("icecandidate",function(e){console.log("icecandidate event:",e),e.candidate?t({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}):console.log("End of candidates.")}),a.addEventListener("track",function(t){"function"==typeof e&&e(t)}),a.setLocalDesc=function(e,t){return a.setLocalDescription(e).then(function(){t(e)}).catch(function(e){return console.log("setLocalDesc error:",e)})},a),key:n.key,isSelf:n.isSelf||!1,CreateOffer:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:w;console.log("this",i),i.RTC.createOffer(t).then(function(t){i.RTC.setLocalDesc(t,e).then(function(){console.log("createOffer setLocalDesc OK")})}).catch(function(e){return console.log("createOffer error:",e)})},CreateAnswer:function(e){i.RTC.createAnswer().then(function(t){i.RTC.setLocalDesc(t,e).then(function(){console.log("CreateAnswer setLocalDesc OK")})}).catch(function(e){return console.log("createAnswer error:",e)})},HandleOffer:function(e,t){var a=new RTCSessionDescription(e);i.RTC.setRemoteDescription(a).then(function(){i.CreateAnswer(t)}).catch(function(e){return console.log("HandleOffer setRemoteDescription error:",e)})},HandleAnswer:function(e,t){var a=new RTCSessionDescription(e);i.RTC.setRemoteDescription(a).then(function(){t()}).catch(function(e){return console.log("HandleAnswer setRemoteDescription error:",e)})}};return i},R={name:"video-call",props:{roomData:{type:Object,required:!0}},data:function(){return{flag:!1,peerMap:{},memberKeys:[],localStream:null,localVideo:null,remoteVideo:null,localMediaConstraints:{video:!0,audio:!0}}},mounted:function(){console.log("open chat video call"),this.init()},computed:{videoCallRtcCandidate:function(){return this.$store.state.msg.VideoCallRtcCandidate},videoCallMsg:function(){return this.$store.state.msg.VideoCall}},watch:{videoCallRtcCandidate:function(){this.videoCallRtcCandidate&&this.videoCallRtcCandidate.status===o.c.candidate&&this.handleSendCandidate()},videoCallMsg:function(){if(this.videoCallMsg)switch(Number(this.videoCallMsg.status)){case o.c.agree:this.$Log("对方同意视频通话",this.videoCallMsg),this.createVideoCall();break;case o.c.createConn:this.$Log("createConn",this.videoCallMsg),this.flag||this.videoCallOfferHandle();break;case o.c.createConnConfirm:this.$Log("收到对方应答",this.videoCallMsg),this.videoCallAnswerHandle()}}},methods:{init:function(){this.localVideo=this.$refs.localVideoRef,this.memberKeys.push(this.roomData.object)},open:function(){var e=this;return!this.videoCallMsg&&(this.getLocalMediaData(function(){e.flag=!0;var t=e.$Chat.videoCall();e.$WebSocket.send(t)}),!0)},close:function(){this.flag=!1},handleRemoteStream:function(e,t){console.log("handleRemoteStream",e,t);var a=this.$refs["remote"+t.key+"VideoRef"][0];this.memberKeys.includes(t.key)&&a&&(a.srcObject=e.streams[0],a.addEventListener("loadedmetadata",function(){a.play()}))},handleSendCandidate:function(){if(this.videoCallRtcCandidate&&this.videoCallRtcCandidate.status===o.c.candidate){var e=JSON.parse(this.videoCallRtcCandidate.content),t=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.peerMap[this.roomData.object].RTC.addIceCandidate(t).catch(function(e){console.log("addIceCandidate-error",e)})}},handleIcecandidate:function(e,t){var a=this.$Chat.videoCall(o.c.candidate);a.parent=this.videoCallMsg.parent||this.videoCallMsg.uuid,a.recipient=this.videoCallMsg.recipient,a.content=M()(e),this.$WebSocket.send(a)},createPeerConn:function(e,t){var a=this;if(!this.peerMap[e]){var n=_({key:e,isSelf:t,handleRemoteStream:this.handleRemoteStream,handleIcecandidate:this.handleIcecandidate});t&&(this.localStream.getTracks().map(function(e){n.RTC.addTrack(e,a.localStream)}),n.CreateOffer(function(e){a.$Log("createVideoCall -> createOffer -> description:",e);var t=a.$Chat.videoCall(o.c.createConn);t.parent=a.videoCallMsg.parent||a.videoCallMsg.uuid,t.recipient=a.videoCallMsg.recipient,t.content=M()(e),a.$WebSocket.send(t)})),this.peerMap[e]=n}return this.peerMap[e]},createVideoCall:function(){var e=this.createPeerConn(this.roomData.object,!0);this.peerMap[this.roomData.object]=e},videoCallAnswerHandle:function(){var e=this.videoCallMsg.sender,t=JSON.parse(this.videoCallMsg.content);this.peerMap[e].HandleAnswer(t,function(){})},getLocalMediaData:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;navigator.mediaDevices.getUserMedia(this.localMediaConstraints).then(function(a){e.localStream=a,e.localVideo.srcObject=a,e.localVideo.play(),"function"==typeof t&&t(a)}).catch(function(t){e.$Log("本地视频采集错误「"+t.toString()+"」"),e.$toast.fail("视频通话暂不可用")})},videoCallOfferHandle:function(){var e=this;this.getLocalMediaData(function(t){if(e.$Log("signHandle videoCallMsg:",e.videoCallMsg),e.videoCallMsg&&e.videoCallMsg.status===o.c.createConn){var a=JSON.parse(e.videoCallMsg.content);e.flag=!0;var n=e.createPeerConn(e.roomData.object,!1);e.peerMap[e.roomData.object]=n,e.localStream.getTracks().map(function(t){n.RTC.addTrack(t,e.localStream)}),e.peerMap[e.roomData.object].HandleOffer(a,function(t){e.$Log("videoCallOfferHandle -> createAnswer -> description:",t);var a=e.$Chat.videoCall(o.c.createConnConfirm);a.parent=e.videoCallMsg.parent||e.videoCallMsg.uuid,a.recipient=e.videoCallMsg.recipient,a.content=M()(t),e.$WebSocket.send(a)})}})}}},x={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",{directives:[{name:"show",rawName:"v-show",value:this.flag,expression:"flag"}],staticClass:"video-call-box"},[t("div",{on:{click:this.close}},[this._v("关闭")]),this._v(" "),t("video",{ref:"localVideoRef",staticStyle:{width:"400px"},attrs:{autoplay:"",playsinline:"",controls:"",id:"localVideo"}}),this._v(" "),this._l(this.memberKeys,function(e){return[t("video",{key:e,ref:"remote"+e+"VideoRef",refInFor:!0,staticStyle:{width:"400px"},attrs:{autoplay:"",playsinline:"",controls:"",id:"remoteVideo"}})]})],2)},staticRenderFns:[]};var b={name:"send-message",components:{VideoCall:a("VU/8")(R,x,!1,function(e){a("QwRB")},"data-v-fe1e5a98",null).exports,SendVideo:p,Add:m,Emoji:f,Voice:h},props:{roomData:{type:Object,required:!0}},data:function(){return{message:"",extraFlag:!1}},mounted:function(){this.$SetR(this.roomData.room)},methods:{showExtra:function(){this.extraFlag=!0},sendTextMessage:function(){this.message=this.message.trim(),""!==this.message&&(this.$WebSocket.send(this.$Chat.text(this.message)),this.$emit("sendMessage",this.message),this.message="")},sendVideoCall:function(){this.$refs.videoCallRef.open()}}},y={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"send-message"},[a("div",{staticClass:"top"},[a("div",{staticClass:"left"},[a("voice")],1),e._v(" "),a("div",{staticClass:"center"},[a("van-field",{staticStyle:{"border-radius":"8px"},attrs:{rows:"1",autosize:{maxHeight:100},type:"textarea"},on:{blur:e.sendTextMessage},model:{value:e.message,callback:function(t){e.message=t},expression:"message"}})],1),e._v(" "),a("div",{staticClass:"right"},[a("emoji"),e._v(" "),a("span",{on:{click:e.showExtra}},[a("add")],1)],1)]),e._v(" "),e.extraFlag?a("div",{staticClass:"extra"},[a("div",{staticClass:"extra-item",on:{click:e.sendVideoCall}},[a("send-video"),e._v(" "),a("span",{staticClass:"title"},[e._v("视频通话")])],1)]):e._e(),e._v(" "),a("video-call",{ref:"videoCallRef",attrs:{"room-data":e.roomData}})],1)},staticRenderFns:[]};var S={name:"chat-box",components:{SendMessage:a("VU/8")(b,y,!1,function(e){a("AIkw")},"data-v-67cc46db",null).exports,MessageList:d},props:{roomData:{type:Object}},mounted:function(){this.$refs.msgListRef.scrollToBottom()},methods:{sendMsg:function(){this.$refs.msgListRef.scrollToBottom()}}},$={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"chat-box"},[t("message-list",{ref:"msgListRef",attrs:{roomData:this.roomData}}),this._v(" "),t("send-message",{attrs:{roomData:this.roomData},on:{sendMessage:this.sendMsg}})],1)},staticRenderFns:[]};var D=a("VU/8")(S,$,!1,function(e){a("Ktc2")},"data-v-3d0fba8a",null);t.a=D.exports},AIkw:function(e,t){},AOzQ:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=a("9GPK"),i=a("ouP4"),s={name:"chat",components:{ChatBox:a("7paM").a,ChatHeader:i.a},data:function(){return{currentRoom:{}}},created:function(){var e=Object(n.c)(n.a);e?this.currentRoom=JSON.parse(e):this.$toast.fail("系统错误")},methods:{goBack:function(){this.$router.push({path:"/index"})}}},o={render:function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"h100"},[t("chat-header",{attrs:{"room-data":this.currentRoom,"back-func":this.goBack}}),this._v(" "),t("chat-box",{attrs:{"room-data":this.currentRoom}})],1)},staticRenderFns:[]};var r=a("VU/8")(s,o,!1,function(e){a("FnSl")},"data-v-d4eb87cc",null);t.default=r.exports},Afxe:function(e,t){},CTDB:function(e,t){},CczY:function(e,t){},FnSl:function(e,t){},Ktc2:function(e,t){},QwRB:function(e,t){},XPRr:function(e,t){},"pNz+":function(e,t){}});
//# sourceMappingURL=2.456040f8f95009001030.js.map